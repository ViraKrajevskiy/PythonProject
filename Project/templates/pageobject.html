{% extends "base.html" %}
{% load static %}

{% block title %}{{ board.title }} | Online Trello{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/board_page.css' %}">
{% endblock %}

{% block content %}
<div class="board-wrapper">
    <nav class="board-sub-nav d-flex align-items-center justify-content-between mb-3 px-4">
        <div class="d-flex align-items-center">
            <a href="{% url 'index' %}" class="btn btn-sm btn-white bg-white bg-opacity-25 text-white border-0 me-3 shadow-none">
                <span class="translate-text">‚Üê –ö —Å–ø–∏—Å–∫—É –¥–æ—Å–æ–∫</span>
            </a>

            {% if role == 'owner' or role == 'admin' %}
            <form action="{% url 'update_board' board.id %}" method="POST" class="d-flex align-items-center m-0">
                {% csrf_token %}
                <div class="position-relative d-flex align-items-center">
                    <span class="board-title-display fw-bold fs-5 text-white translate-text me-3"
                          style="cursor: pointer; padding: 2px 8px; border-radius: 4px;"
                          onclick="this.classList.add('d-none'); this.nextElementSibling.classList.remove('d-none'); this.nextElementSibling.focus();">
                        {{ board.title }}
                    </span>
                    <input type="text" name="title" class="form-control form-control-sm bg-white text-dark border-0 fw-bold fs-5 shadow-none d-none me-3"
                           value="{{ board.title }}" onblur="this.form.submit()">

                    <div class="form-check form-switch text-white small m-0">
                        <input class="form-check-input" type="checkbox" name="enable_comments" id="commentSwitch"
                               {% if board.enable_comments %}checked{% endif %} onchange="this.form.submit()">
                        <label class="form-check-label translate-text" for="commentSwitch">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</label>
                    </div>
                </div>
            </form>
            {% else %}
                <span class="fw-bold fs-5 text-white translate-text">{{ board.title }}</span>
            {% endif %}
        </div>

        <div class="d-flex align-items-center gap-3 text-white">
            <div class="small d-none d-md-block text-end">
                <span class="opacity-75 translate-text">–ê–≤—Ç–æ—Ä:</span>
                <strong class="translate-text d-block">{{ board.owner.username }}</strong>
            </div>
            {% if board.owner == user %}
            <button class="btn btn-sm btn-warning fw-bold shadow-none rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#manageMembersModal">
                <span class="translate-text">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</span> ({{ board.members.count }})
            </button>
            {% endif %}
        </div>
    </nav>

    <main class="board-canvas">
        {% for column in columns %}
        <div class="column-wrapper">
            <div class="card column-card border-0 shadow-lg">
                <div class="card-header d-flex justify-content-between align-items-start">
                    {% if role != 'viewer' %}
                    <form action="{% url 'update_column' column.id %}" method="POST" class="m-0 flex-grow-1">
                        {% csrf_token %}
                        <div class="position-relative">
                            <span class="fw-bold translate-text d-block" style="cursor: pointer;"
                                  onclick="this.classList.add('d-none'); this.nextElementSibling.classList.remove('d-none'); this.nextElementSibling.focus();">
                                {{ column.title }}
                            </span>
                            <input type="text" name="title" class="form-control form-control-sm bg-white border-0 fw-bold p-1 shadow-none d-none"
                                   value="{{ column.title }}" onblur="this.form.submit()">
                        </div>
                    </form>
                    {% else %}
                        <span class="fw-bold translate-text">{{ column.title }}</span>
                    {% endif %}

                    {% if role != 'viewer' %}
                    <div class="dropdown">
                        <span class="column-menu-btn text-muted" data-bs-toggle="dropdown" style="cursor:pointer">‚ãÆ</span>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                            <li>
                                <form action="{% url 'delete_column' column.id %}" method="POST" class="m-0">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item text-danger small translate-text" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å?')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                                </form>
                            </li>
                        </ul>
                    </div>
                    {% endif %}
                </div>

                <div class="card-body task-container p-2">
                    {% for task in column.tasks.all %}
                    {% if not task.is_archived %}
                    <div class="card task-item {% if task.is_completed %}task-done{% endif %}"
                         style="border-left: 5px solid {{ task.label_color|default:'#0052cc' }} !important;"
                         onclick="if(!event.target.classList.contains('task-checkbox')){ openTaskModal('{{ task.id }}'); }">

                        <div class="d-flex align-items-start gap-2">
                            {% if role != 'viewer' %}
                            <form action="{% url 'toggle_task' task.id %}" method="POST" class="m-0">
                                {% csrf_token %}
                                <input type="checkbox" class="form-check-input task-checkbox shadow-none" {% if task.is_completed %}checked{% endif %} onchange="this.form.submit()">
                            </form>
                            {% endif %}
                            <span class="task-text translate-text text-dark fw-medium">{{ task.text }}</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="d-flex flex-wrap gap-1">
                                {% if task.task_role %}<span class="task-role-badge">{{ task.task_role }}</span>{% endif %}
                                {% if task.due_date %}<div class="task-date-badge">üìÖ {{ task.due_date|date:"d M" }}</div>{% endif %}
                                {% if task.attachment %}<span class="text-muted small">üìé</span>{% endif %}
                            </div>

                            {% if task.assigned_to %}
                                <div class="assignee-circle" title="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {{ task.assigned_to.username }}">
                                    {% if task.assigned_to.avatar %}
                                        <img src="{{ task.assigned_to.avatar.url }}" alt="AV">
                                    {% else %}
                                        {{ task.assigned_to.username|slice:":1"|upper }}
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

                {% if role != 'viewer' %}
                <div class="card-footer border-0 bg-transparent">
                    <form action="{% url 'add_task' %}" method="POST" class="m-0">
                        {% csrf_token %}
                        <input type="hidden" name="column_id" value="{{ column.id }}">
                        <input type="text" name="text" class="form-control form-control-sm border-0 shadow-none bg-dark bg-opacity-10 translate-text" placeholder="+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É" required>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        {% if role != 'viewer' %}
        <div class="column-wrapper">
            <div class="card bg-white bg-opacity-25 border-0 shadow-sm" style="border-radius: 12px;">
                <div class="card-body p-2">
                    <form action="{% url 'create_column' board.id %}" method="POST" class="m-0">
                        {% csrf_token %}
                        <input type="text" name="title" class="form-control form-control-sm border-0 shadow-none mb-2" placeholder="+ –î–æ–±–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫" required>
                        <button type="submit" class="btn btn-primary btn-sm w-100 fw-bold">–î–æ–±–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
    </main>
</div>

<div class="modal fade" id="universalTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg text-dark" id="taskModalContent">
            <div class="p-5 text-center">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
    </div>
</div>

{% if board.owner == user %}
<div class="modal fade" id="manageMembersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg text-dark">
            <div class="modal-header border-0 bg-light">
                <h5 class="modal-title fw-bold">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–æ—Å–∫–∏</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="{% url 'invite_user' board.id %}" method="POST" class="mb-3">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" name="username" class="form-control" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" required>
                        <button type="submit" class="btn btn-primary fw-bold">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </form>
                <div class="list-group">
                    {% for member in board.members.all %}
                    <div class="list-group-item d-flex justify-content-between align-items-center border-0 bg-light mb-2 rounded shadow-sm">
                        <div class="d-flex align-items-center gap-2">
                             <div class="user-avatar-sm" style="width:28px; height:28px; font-size:11px;">
                                {% if member.user.avatar %}
                                    <img src="{{ member.user.avatar.url }}" class="rounded-circle w-100 h-100 object-fit-cover">
                                {% else %}
                                    {{ member.user.username|slice:":1"|upper }}
                                {% endif %}
                             </div>
                             <span>{{ member.user.username }} <small class="text-muted">({{ member.role }})</small></span>
                        </div>
                        <form action="{% url 'remove_member' board.id member.id %}" method="POST" class="m-0">
                            {% csrf_token %}
                            <button class="btn btn-sm text-danger shadow-none">–£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/board_page.js' %}"></script>
{% endblock %}